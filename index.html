<html>

<head>
    <title>Flow of College Students from State to State</title>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="state_location_data.js"></script>
    <script src="Data/state_data.js"></script>
</head>

<body>
    <button name="toggle" onclick="toggle();">Toggle leaving/entering</button><label for="toggle" id="label">Leaving</label><br/>
    <script>
        nums = [];
        for (var st in state_data) {
            if (state_data.hasOwnProperty(st)) {
                nums.push(state_data[st]["leaving"].data.perc);
            }
        }
        console.log(nums.sort(function(a, b) {
            return (parseInt(a) < parseInt(b)) ? -1 : 1;
        }));
        // Build the map
        var width = 1000;
        height = 500;

        var svg = d3.select("body")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        var g = svg.append("g");

        var projection = d3.geo.albersUsa()
            .scale(1000)
            .translate([width / 2, height / 2]);

        var geoPath = d3.geo.path()
            .projection(projection);

        // From data set
        var totalLeaving = 260042;
        var avgLeavingFactor = 0.02;
        var totalCollegePop = 932902;
        var avgLeavingPerc = 36.490196078431374;

        var showLeave = true;
        var showEnter = false;
        var arr = [];
        g.selectAll("path")
            .data(stateshighres.features)
            .enter()
            .append("path")
            .attr("fill", getFill)
            .attr("d", geoPath);

        function getFill(d) {
            var name = d.properties.NAME;
            var data = state_data[name];
            var entering = data["entering"].data / totalLeaving - avgLeavingFactor; // 0.02 is "average"
            arr.push(entering);
            var enteringFactor = Math.floor(entering * 50 * 255);
            var leaving = (data["leaving"].data.perc - avgLeavingPerc) / 100;
            var leavingFactor = Math.floor(leaving * 5 * 255);
            console.log(leaving);
            if (showLeave) {
                return "rgb(" + leavingFactor + ", 0, " + (-1 * leavingFactor) + ")";
            } else if (showEnter) {
                return "rgb(" + enteringFactor + ", 0, " + (-1 * enteringFactor) + ")";
            }
        }

        function toggle() {
            showLeave = !showLeave;
            showEnter = !showEnter;
            if (showEnter) {
                document.getElementById("label").innerText = "Entering";
            } else {
                document.getElementById("label").innerText = "Leaving";
            }
            recalc();
        }

        function recalc() {
            g.selectAll("path").remove();
            g.selectAll("path")
                .data(stateshighres.features)
                .enter()
                .append("path")
                .attr("fill", getFill)
                .attr("d", geoPath);
        }
    </script>
</body>

</html>
